var ue=Object.defineProperty;var de=(c,e,s)=>e in c?ue(c,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):c[e]=s;var M=(c,e,s)=>de(c,typeof e!="symbol"?e+"":e,s);import{u as ge,d as ee,r as T,n as P,H as ve,p as pe,c as C,e as g,f as _,w as m,b as l,I as J,j as N,F as j,G as q,J as he,D as G,y as V,h as Y,K as E,L as Q,o as L,M as z,N as me,O as Se,_ as se}from"./index-BsYwGHgQ.js";import{r as H}from"./request-XtDRsfb_.js";const X=ge(),A={chat:async(c,e)=>{console.log(`[Debug] chat begin for session: ${c}`);let s=c;try{await H.post("http://222.20.98.159:5180/api/resume/chat",{session_id:c,content:e},{headers:{Authorization:`Bearer ${X.getToken}`,Accept:"text/event-stream","Cache-Control":"no-cache"},responseType:"text",onDownloadProgress:o=>{var i,$;const a=($=(i=o.event)==null?void 0:i.target)==null?void 0:$.responseText;if(!a)return;const p=a.split(`
`);for(const x of p)if(x.startsWith("data: "))try{const w=x.slice(6);console.log("Raw SSE data:",w);let f;try{f=JSON.parse(w)}catch(b){console.warn(`无法解析JSON数据: ${b}`,w);continue}console.log("Parsed JSON:",f);const y=f.session_id;if(f.type==="text"){console.log("Dispatching text event for session:",y);const b=new CustomEvent(`sse-message-${y}`,{detail:{type:"text",content:f.content||"",session_id:y}});window.dispatchEvent(b)}else if(f.type==="end"){s=f.session_id,console.log(`Chat completed for session ${y}`);const b=new CustomEvent(`sse-session-completed-${y}`,{detail:{session_id:y}});window.dispatchEvent(b)}}catch(w){console.warn("处理SSE数据失败:",w,x);try{const f=x.match(/"session_id"\s*:\s*"([^"]+)"/),y=f?f[1]:c,b=new CustomEvent(`sse-error-${y}`,{detail:{error:w,session_id:y,message:"数据解析错误"}});window.dispatchEvent(b)}catch{}}}})}catch(o){console.error(`[Error] chat failed for session ${c}:`,o);const a=new CustomEvent(`sse-error-${c}`,{detail:{error:o,session_id:c}});throw window.dispatchEvent(a),o}return console.log(`[Debug] chat finished for session ${c}, returned ID: ${s}`),s},upload:async c=>{const e=new FormData;return e.append("file",c.file),H.post("http://222.20.98.159:5180/api/resume/upload",e,{headers:{"Content-Type":"multipart/form-data"}})},createNewSession:async()=>{try{const e=await H.get("http://222.20.98.159:5180/api/resume/newSession",{headers:{Authorization:`Bearer ${X.getToken}`}});return console.log("response:",e),e.data.session_id}catch(c){throw console.error("创建会话失败:",c),c}},getResumeHistory:()=>H.get("/api/resume/history"),getResumeScore:c=>H.get(`/api/resume/score/${c}`)},Z="resume_chat_history",D=class D{constructor(){M(this,"history");M(this,"activeStreamingSessions",new Set);M(this,"eventListeners",new Map);this.history=this.loadHistory(),this.initializeSessionStates()}static getInstance(){return D.instance||(D.instance=new D),D.instance}initializeSessionStates(){this.history.sessions&&this.history.sessions.forEach(e=>{e.state||(e.state=this.createDefaultSessionState())})}loadHistory(){const e=localStorage.getItem(Z);if(e)try{return JSON.parse(e)}catch(s){console.error("Failed to parse chat history:",s)}return{sessions:[],current_session_id:null}}saveHistory(){localStorage.setItem(Z,JSON.stringify(this.history))}createDefaultSessionState(){return{typingIndex:-1,isStreaming:!1,lastContent:""}}createSession(e,s){const o=Date.now(),a={session_id:e,messages:[],created_at:o,updated_at:o,title:s,state:this.createDefaultSessionState()};return this.history.sessions.push(a),this.history.current_session_id=e,this.saveHistory(),a}addMessage(e,s){const o=this.history.sessions.find(a=>a.session_id===e);o&&(o.messages.push(s),o.updated_at=Date.now(),this.saveHistory())}getCurrentSession(){return this.history.current_session_id&&this.history.sessions.find(e=>e.session_id===this.history.current_session_id)||null}getSession(e){return this.history.sessions.find(s=>s.session_id===e)||null}getAllSessions(){return this.history.sessions.sort((e,s)=>s.updated_at-e.updated_at)}switchSession(e){this.history.sessions.some(s=>s.session_id===e)&&(this.history.current_session_id=e,this.saveHistory())}deleteSession(e){var s;this.isSessionStreaming(e)&&this.stopSessionStreaming(e),this.history.sessions=this.history.sessions.filter(o=>o.session_id!==e),this.history.current_session_id===e&&(this.history.current_session_id=((s=this.history.sessions[0])==null?void 0:s.session_id)||null),this.saveHistory()}getSessionState(e){const s=this.getSession(e);return s?s.state:null}updateSessionState(e,s){const o=this.getSession(e);o&&(o.state={...o.state,...s},this.saveHistory())}getTypingIndex(e){const s=this.getSessionState(e);return s?s.typingIndex:-1}updateTypingIndex(e,s){this.updateSessionState(e,{typingIndex:s})}isStreaming(e){const s=this.getSessionState(e);return s?s.isStreaming:!1}startSessionStreaming(e){this.activeStreamingSessions.add(e),this.updateSessionState(e,{isStreaming:!0})}stopSessionStreaming(e){this.activeStreamingSessions.delete(e),this.updateSessionState(e,{isStreaming:!1}),this.removeAllSessionListeners(e)}saveSession(e,s){const o=this.getSession(e);o&&(o.messages=[...s],o.updated_at=Date.now(),this.saveHistory())}resetTypingIndex(e){this.updateTypingIndex(e,0)}isSessionStreaming(e){return this.activeStreamingSessions.has(e)}addSessionListener(e,s,o){var p;const a=`${s}-${e}`;this.eventListeners.has(a)||this.eventListeners.set(a,new Set),(p=this.eventListeners.get(a))==null||p.add(o),window.addEventListener(`${s}-${e}`,o)}removeSessionListener(e,s,o){const a=`${s}-${e}`,p=this.eventListeners.get(a);p&&p.has(o)&&(p.delete(o),window.removeEventListener(`${s}-${e}`,o))}removeAllSessionListeners(e){for(const[s,o]of this.eventListeners.entries())if(s.endsWith(`${e}`)){for(const a of o)window.removeEventListener(s,a);this.eventListeners.delete(s)}}clearEvnetListeners(){for(const[e,s]of this.eventListeners.entries()){for(const o of s)window.removeEventListener(e,o);this.eventListeners.delete(e)}}async safelyInterruptSession(e){return new Promise(s=>{if(this.isSessionStreaming(e)){const o=()=>{s()};this.addSessionListener(e,"sse-session-completed",o),setTimeout(()=>{this.removeSessionListener(e,"sse-session-completed",o),this.stopSessionStreaming(e),s()},5e3)}else s()})}};M(D,"instance");let R=D;const fe={class:"resume-container"},ye={class:"card-header"},we={class:"header-left"},_e={class:"chat-layout"},$e={key:0,class:"session-list"},xe={class:"session-list-header"},be={class:"session-items"},Ce=["onClick"],Le={class:"session-title"},Te={class:"session-time"},Ie={key:0,class:"streaming-indicator"},Ee={class:"chat-container"},De={class:"message-content"},ke={class:"message-header"},Me={class:"message-role"},He=["innerHTML"],Ae={class:"chat-input"},Ne="https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png",Be="https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png",Ve=ee({__name:"index",setup(c){const e=R.getInstance(),s=T([]),o=T(""),a=T(!1),p=T(null),i=T(""),$=T(!1),x=P(()=>i.value?e.isSessionStreaming(i.value):!1),w=P(()=>e.getAllSessions()),f=t=>new Date(t).toLocaleString(),y=t=>e.isSessionStreaming(t),b=async t=>{console.log("切换到会话:",t),i.value&&e.saveSession(i.value,s.value),i.value=t;const n=e.getSession(t);n?(s.value=[...n.messages],e.resetTypingIndex(t),console.log("加载会话消息:",s.value.length,"条消息")):(s.value=[],console.log("创建新会话")),o.value="",await Q(()=>{I()})},te=async t=>{if(e.isSessionStreaming(t)){E.warning("无法删除正在进行的会话");return}try{if(await Se.confirm("确定要删除这个会话吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),e.deleteSession(t),t===i.value){const n=e.getAllSessions();n.length>0?(i.value=n[0].session_id,K()):(i.value="",s.value=[],U())}E.success("会话已删除")}catch{}},ne=()=>{i.value="",s.value=[],U(),$.value=!1},oe=async()=>{if(!o.value.trim())return;console.log("开始处理对话");const t=o.value.trim(),n={role:"user",content:t,timestamp:Date.now()};s.value.push(n),o.value="";const d={role:"assistant",content:"",timestamp:Date.now()};s.value.push(d),I();let r=i.value;if(r)e.addMessage(r,n);else try{r=await A.createNewSession(),r&&(i.value=r,e.createSession(r,t.substring(0,30)+"..."),e.addMessage(r,n),console.log("创建新会话:",r))}catch(u){console.error("创建会话失败:",u),s.value[s.value.length-1].content="创建会话失败，请重试";return}try{F(r),e.startSessionStreaming(r),e.resetTypingIndex(r),e.saveSession(r,s.value),console.log(`发送聊天请求，会话ID: ${r}`);const u=await A.chat(r,t);u&&u!==r&&console.log(`会话ID更新: ${r} -> ${u}`),console.log("聊天完成，返回会话ID:",u)}catch(u){console.error("对话失败:",u),e.stopSessionStreaming(r)}},W=async()=>{if(o.value.trim()){if(i.value&&e.isSessionStreaming(i.value)){E.warning("请等待当前回复完成");return}a.value=!0;try{await oe()}finally{a.value=!1}}},K=()=>{console.log(`加载会话 ${i.value} 的历史消息`);const t=e.getSession(i.value);if(t){if(s.value=[...t.messages],e.isSessionStreaming(i.value)){console.log(`会话 ${i.value} 正在流式接收中`);const n=e.getSessionState(i.value);if(n&&n.lastContent&&s.value.length>0){const d=s.value[s.value.length-1];if(d.role==="assistant"){const r=e.getTypingIndex(i.value);r>=0&&r<n.lastContent.length?(d.content=n.lastContent.substring(0,r+1),console.log(`恢复打字效果，索引: ${r}`),O(i.value,n.lastContent,r)):d.content=n.lastContent}}}I()}else s.value=[]},U=()=>{const t={role:"assistant",content:`您好！我是您的简历修改助手。

您可以：
1. 直接上传 Word 格式的简历
2. 告诉我您想修改的内容
3. 询问简历相关的任何问题

我会为您提供专业的建议和指导。`,timestamp:Date.now()};s.value.push(t)},ae=async t=>{E.success("简历上传成功");try{const n=await A.createNewSession();n&&(i.value=n,e.createSession(n,"简历分析会话"),console.log("初始化会话ID:",i.value),F(n),e.startSessionStreaming(n),await A.chat(n,"你好，请分析我的简历"));const d={role:"assistant",content:`我已经收到您的简历，我可以帮您：
1. 分析简历内容
2. 提供修改建议
3. 优化表达方式
4. 调整格式结构

请告诉我您想先从哪个方面开始？`,timestamp:Date.now()};s.value.push(d),i.value&&e.addMessage(i.value,d)}catch(n){console.error("[Debug] handleUploadSuccess error:",n),E.error("初始化对话失败")}finally{I()}},ie=()=>{E.error("简历上传失败，请重试")},re=t=>!0;ve(()=>{e.clearEvnetListeners()}),pe(()=>{K(),s.value.length===0&&U()});const O=(t,n,d)=>{console.log(`typeWriter: 会话${t}，长度${n.length}，起始位置${d}`);const r=typeof n=="string"?n:String(n);let u=e.getTypingIndex(t);if((u<0||u<d)&&(u=d),u>=r.length){console.log(`已完成会话${t}的打字，当前索引${u}，文本长度${r.length}`);return}if(e.updateSessionState(t,{typingIndex:u}),i.value===t&&s.value.length>0){const h=s.value.length-1,S=s.value[h];S&&S.role==="assistant"?(console.log(`更新UI: 会话${t}，显示到位置${u}`),S.content=r.substring(0,u+1),I()):console.log(`警告: 未找到助手消息，当前消息长度${s.value.length}`)}setTimeout(()=>{if(e.isSessionStreaming(t)){const h=e.getSessionState(t),S=(h==null?void 0:h.lastContent)||r;O(t,S,u+1)}else if(console.log(`会话${t}已停止流式接收，完成索引${u}`),i.value===t&&s.value.length>0){const h=s.value[s.value.length-1];h&&h.role==="assistant"&&h.content!==r&&(h.content=r,I())}},20)},F=t=>{console.log(`创建会话 ${t} 的消息处理器`),le(t);const n=e.getTypingIndex(t),d=h=>{const S=h.detail;if(console.log(`收到会话 ${t} 的消息，当前活跃会话: ${i.value}`),S&&S.type==="text"){if(typeof S.content=="string"){const k=e.getSessionState(t)||{};e.updateSessionState(t,{...k,lastContent:S.content}),i.value===t&&O(t,S.content,n>=0?n:0)}i.value===t&&I()}};e.addSessionListener(t,"sse-message",d);const r=h=>{var k;if(console.log(`会话 ${t} 完成接收`),e.stopSessionStreaming(t),t==i.value)return;const S=(k=e.getSessionState(t))==null?void 0:k.lastContent;S&&e.addMessage(t,{role:"assistant",content:S,timestamp:Date.now()})};e.addSessionListener(t,"sse-session-completed",r);const u=h=>{console.error(`会话 ${t} 出错:`,h.detail),i.value===t&&(E.error("对话失败，请重试"),s.value.length>0&&s.value[s.value.length-1].role==="assistant"&&(s.value[s.value.length-1].content+=`
[对话中断]`,e.saveSession(t,s.value))),e.stopSessionStreaming(t)};return e.addSessionListener(t,"sse-error",u),{messageHandler:d,completionHandler:r,errorHandler:u}},le=t=>{e.removeAllSessionListeners(t),console.log(`已移除会话 ${t} 的消息处理器`)},I=async()=>{await Q(),p.value&&(p.value.scrollTop=p.value.scrollHeight)};return(t,n)=>{const d=_("el-button"),r=_("el-upload"),u=_("el-icon"),h=_("el-scrollbar"),S=_("el-avatar"),k=_("el-input"),ce=_("el-card");return L(),C("div",fe,[g(ce,{class:"resume-card"},{header:m(()=>[l("div",ye,[l("div",we,[n[2]||(n[2]=l("span",null,"简历修改助手",-1)),g(d,{type:"primary",onClick:n[0]||(n[0]=v=>$.value=!$.value)},{default:m(()=>[N(V($.value?"隐藏会话列表":"显示会话列表"),1)]),_:1})]),g(r,{class:"upload-demo","http-request":Y(A).upload,"on-success":ae,"on-error":ie,"before-upload":re,accept:".doc,.docx,.md,.pdf"},{default:m(()=>[g(d,{type:"primary"},{default:m(()=>n[3]||(n[3]=[N("上传简历")])),_:1})]),_:1},8,["http-request"])])]),default:m(()=>[l("div",_e,[$.value?(L(),C("div",$e,[l("div",xe,[n[5]||(n[5]=l("h3",null,"历史会话",-1)),g(d,{type:"text",onClick:ne},{default:m(()=>n[4]||(n[4]=[N("新建会话")])),_:1})]),g(h,null,{default:m(()=>[l("div",be,[(L(!0),C(j,null,q(w.value,v=>(L(),C("div",{key:v.session_id,class:z(["session-item",{active:v.session_id===i.value,"is-streaming":y(v.session_id)}]),onClick:B=>b(v.session_id)},[l("div",Le,V(v.title),1),l("div",Te,V(f(v.updated_at)),1),y(v.session_id)?(L(),C("div",Ie,n[6]||(n[6]=[l("div",{class:"dot"},null,-1),l("div",{class:"dot"},null,-1),l("div",{class:"dot"},null,-1)]))):J("",!0),g(d,{type:"text",class:"delete-session",onClick:G(B=>te(v.session_id),["stop"]),disabled:y(v.session_id)},{default:m(()=>[g(u,null,{default:m(()=>[g(Y(me))]),_:1})]),_:2},1032,["onClick","disabled"])],10,Ce))),128))])]),_:1})])):J("",!0),l("div",Ee,[l("div",{class:"chat-messages",ref_key:"messagesContainer",ref:p},[(L(!0),C(j,null,q(s.value,(v,B)=>(L(),C("div",{key:B,class:z(["message",v.role])},[l("div",De,[l("div",ke,[g(S,{size:32,src:v.role==="user"?Ne:Be},null,8,["src"]),l("span",Me,V(v.role==="user"?"我":"简历助手"),1)]),l("div",{class:z(["message-text",{"message-stream":v.role==="assistant"&&x.value&&B===s.value.length-1}]),innerHTML:v.content},null,10,He)])],2))),128))],512),l("div",Ae,[g(k,{modelValue:o.value,"onUpdate:modelValue":n[1]||(n[1]=v=>o.value=v),type:"textarea",rows:3,placeholder:"请输入您的问题...",onKeyup:he(G(W,["ctrl"]),["enter"]),disabled:x.value},null,8,["modelValue","onKeyup","disabled"]),g(d,{type:"primary",onClick:W,loading:a.value,disabled:x.value},{default:m(()=>n[7]||(n[7]=[N("发送")])),_:1},8,["loading","disabled"])])])])]),_:1})])}}}),Ue=se(Ve,[["__scopeId","data-v-505303c9"]]),Oe={class:"education-container"},ze={class:"content"},Je={key:0},Re=ee({__name:"index",setup(c){const e=T(!1),s=T("courses");return(o,a)=>{const p=_("el-tab-pane"),i=_("el-button"),$=_("el-tabs"),x=_("el-card");return L(),C("div",Oe,[g(x,{class:"education-card"},{header:m(()=>a[2]||(a[2]=[l("div",{class:"card-header"},[l("span",null,"教学科研")],-1)])),default:m(()=>[g($,{modelValue:s.value,"onUpdate:modelValue":a[1]||(a[1]=w=>s.value=w)},{default:m(()=>[g(p,{label:"课程管理",name:"courses"},{default:m(()=>a[3]||(a[3]=[l("div",{class:"content"},[l("h3",null,"课程管理系统"),l("p",null,"管理课程信息、教学计划和课程资源")],-1)])),_:1}),g(p,{label:"科研项目",name:"research"},{default:m(()=>a[4]||(a[4]=[l("div",{class:"content"},[l("h3",null,"科研项目管理"),l("p",null,"管理科研项目、论文发表和科研成果")],-1)])),_:1}),g(p,{label:"职业发展",name:"career","keep-alive":"True"},{default:m(()=>[l("div",ze,[a[6]||(a[6]=l("h3",null,"职业发展支持",-1)),a[7]||(a[7]=l("p",null,"提供简历智能修改与评分服务，实现能力画像与岗位需求匹配",-1)),g(i,{type:"primary",onClick:a[0]||(a[0]=w=>e.value=!e.value)},{default:m(()=>a[5]||(a[5]=[N("简历修改")])),_:1}),e.value?(L(),C("div",Je,[g(Ue)])):J("",!0)])]),_:1})]),_:1},8,["modelValue"])]),_:1})])}}}),Pe=se(Re,[["__scopeId","data-v-710f39ad"]]);export{Pe as default};
